name: Install Ansible on Ubuntu

on:
  workflow_dispatch:
  push:

jobs:
  install-ansible:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH key
        run: |
          mkdir -p /home/runner/.ssh
          chmod 700 /home/runner/.ssh
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > /home/runner/.ssh/id_rsa
          chmod 600 /home/runner/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> /home/runner/.ssh/known_hosts

      - name: Run test playbook remotely
        run: |
          ssh -i /home/runner/.ssh/id_rsa -tt ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "---" > test-playbook.yml
            echo "- name: Test Ansible connectivity and file creation" >> test-playbook.yml
            echo "  hosts: localhost" >> test-playbook.yml
            echo "  become: yes" >> test-playbook.yml
            echo "  tasks:" >> test-playbook.yml
            echo "    - name: Create a test file" >> test-playbook.yml
            echo "      file:" >> test-playbook.yml
            echo "        path: /tmp/ansible-test-success.txt" >> test-playbook.yml
            echo "        state: touch" >> test-playbook.yml
            ansible-playbook test-playbook.yml
          EOF
